<!DOCTYPE html>
<html>
    <head>
       <meta charset="utf-8">
       <title class = "header">DuckedIn Create Profile</title>
       <link rel="stylesheet" href="createAccount.css">
    </head>

    <body>
        <h2>Create A Profile</h2>
            <!--/database_file.sql is the file where the data will be stored; this is not the actual name-->
           
            <form database = "/database_file.sql">
                <label UserInput1 = "firstname">First Name: </label>
                <input type = "text" id = "firstname" name = "firstname"><br>

                <label UserInput2 = "lastname">Last Name: </lable>
                <input type = "text" id = "lastname" name = "lastname"><br>

                <label UserInput3 = "username">Username: </label>
                <input type = "text" id = "username" name = "username"><br>
                
                <label UserInput4 = "password">Password: </label>
                <input type = "text" id = "password" name = "password"><br>

                <label UserInput5 = "age">Age: </label>
                <input type = "text" id = "age" name = "age"><br>

                <label UserInput6 = "major">Major: </label>
                <input type = "text" id = "major" name = "major"><br>

                <label UserInput7 = "gradyear">Graduation Year: </label>
                <input type = "text" id = "gradyear" name = "gradyear"><br>

                <label UserInput8 = "jobexp">Job Experience: </label>
                <input type = "text" id = "jobexp" name = "jobexp"><br>

                <label UserInput9 = "currentemp">Current Employment: </label>
                <input type = "text" id = "currentemp" name = "currentemp"><br><br>
                
                <!--Button to submit all the info to the database-->
                <button id=submit_account onclick='post()'>Submit</button>
            </form>

            <script src="//cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
            <script>

                var crypt = {
                // (B1) THE SECRET KEY
                secret : "vtJHEGLQerdNhsmnsG1R26K0aAm1wp5kPrhlUp50xU3T2pVwaJpiqErNLH3tUlAIemKXre4gpW5DFk16eyH6qRr5kQIhmR7lewsZtkB9JiauEOLR3bL9XQbBbY12unTW",
                
                // (B2) ENCRYPT
                encrypt : function (clear) {
                    var cipher = CryptoJS.AES.encrypt(clear, crypt.secret);
                    cipher = cipher.toString();
                    return cipher;
                },
                
                // (B3) DECRYPT
                decrypt : function (cipher) {
                    var decipher = CryptoJS.AES.decrypt(cipher, crypt.secret);
                    decipher = decipher.toString(CryptoJS.enc.Utf8);
                    return decipher;
                }
                };

                var firstname = document.getElementById('firstname').value;
                var lastname = document.getElementById('lastname').value;
                var username = document.getElementById('username').value;
                var password = crypt.encrypt(document.getElementById('password').value);
                var major = document.getElementById('major').value;
                var gradyear = document.getElementById('gradyear').value;
                var job = document.getElementById('jobexp').value;
                var current = document.getElementById('currentemp').value;

                axios.get('https://sheetdb.io/api/v1/9kxufr2k05mi6?sheet=Client_Data')
                    .then( response => {
                        var users = response.data;
                        var condition = true;
                        while(condition){
                            var isid = Math.floor(Math.random() * 100000)
                            for (i=0; i < users.length; i++){
                                if(users[i].ISID == isid){
                                    break;
                                }
                            }
                            if(i == users.length){
                                condition = false;
                                const cookie = escape('ISID') + "=" + escape(isid);
                                document.cookie = cookie;
                                console.log(cookie);
                                console.log("Creating new cookie with key: ISID value: " + isid);
                            }
                        }
                });

                function readCookie(name) {
                    let key = name + "=";
                    let cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        let cookie = cookies[i];
                        while (cookie.charAt(0) === ' ') {
                            cookie = cookie.substring(1, cookie.length);
                        }
                        if (cookie.indexOf(key) === 0) {
                            return cookie.substring(key.length, cookie.length);
                        }
                    }
                    return null;
                }

                axios.post('https://sheetdb.io/api/v1/9kxufr2k05mi6?sheet=Client_Data',{
                    "data": {"ISID": readCookie('ISID'), "First_Name": firstname, "Last_Name": lastname, "Age": age, "Password": password, "Username": username, "Major": major, "Graduation_Year": gradyear, "Job_Experience": job, "Current_Employment": current}
                }).then( response => {
                    console.log(response.data);
                    console.log({"ISID": readCookie('ISID'), "First_Name": firstname, "Last_Name": lastname, "Age": age, "Password": password, "Username": username, "Major": major, "Graduation_Year": gradyear, "Job_Experience": job, "Current_Employment": current})
                    //window.location.href = '../homepage/homepage.html'
                });
            </script>

            <p>Create new account page works</p>


    </body>
</html>

